<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FastBot Console</title>

  <!-- Bootstrap 4 -->
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
    crossorigin="anonymous"
  />

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>

  <!-- ROS libs -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/eventemitter2/lib/eventemitter2.min.js"></script>
  <script src="./libs/roslib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eventemitter2@5.0.1/lib/eventemitter2.min.js"></script>

  <!-- Camera streaming -->
  <script src="mjpegcanvas.min.js" type="text/javascript"></script>

  <!-- 2D map and 3D robot Visualization libs -->
  <script src="https://cdn.jsdelivr.net/npm/easeljs/lib/easeljs.min.js"></script>
  <script src="./libs/ros2d.js"></script>
  <script src="./libs/three.min.js"></script>
  <script src="./libs/ColladaLoader.js"></script>
  <script src="./libs/ColladaLoader2.js"></script>
  <script src="./libs/STLLoader.js"></script>
  <script src="./libs/ros3d.min.js"></script>

  <!-- Joystick -->
  <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.10.1/dist/nipplejs.min.js"></script>

  <style>
    :root {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --ink: #1e293b;
      --muted: #64748b;
      --accent: #0ea5a4;
      --accent-2: #f59e0b;
      --ring: rgba(14, 165, 164, 0.25);
      --ok: #16a34a;
      --bad: #ef4444;
      --border: #e5e7eb;
    }

    html, body {
      height: 100%;
    }

    body {
      background: var(--bg);
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app-shell {
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 16px;
    }

    /* Top bar */
    .topbar {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 10px rgba(2, 8, 23, 0.04);
    }

    .brand {
      font-weight: 800;
      letter-spacing: 0.2px;
      color: var(--ink);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 0.85rem;
      color: var(--muted);
      background: #fff;
    }

    .dot {
      width: 10px; height: 10px; border-radius: 50%; margin-right: 8px;
      background: var(--bad);
    }

    .dot.on { background: var(--ok); }

    .btn-accent { background: var(--accent); border-color: var(--accent); }
    .btn-accent:hover { filter: brightness(0.95); }
    .btn-emph { background: var(--accent-2); border-color: var(--accent-2); color: #1f2937; font-weight: 700; }

    /* Layout */
    .content {
      display: grid;
      grid-template-columns: 300px 1fr 380px;
      gap: 16px;
    }

    @media (max-width: 1199.98px) {
      .content { grid-template-columns: 1fr; }
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(2, 8, 23, 0.04);
    }
    .panel h6 { font-weight: 700; color: var(--muted); letter-spacing: 0.4px; }

    .panel-body { padding: 16px; }

    .viewer {
      height: 320px;
      background: #0b1220;
      border-radius: 12px;
      border: 1px solid #0f172a;
      position: relative;
      overflow: hidden;
    }

    .viewer.tall { height: 360px; }

    .status-chip {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .chip {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      background: #fff;
    }

    .chip .v { font-weight: 800; font-size: 1.1rem; color: var(--accent-2); }
    .chip small { color: var(--muted); }

    .joystick-wrap {
      width: 220px; height: 220px; margin: 0 auto; border-radius: 14px;
      border: 2px dashed var(--accent);
      background: rgba(14,165,164,0.06);
      display: grid; place-items: center;
    }
      #joystickContainer{
        width: 200px;
        height: 200px;
        position: relative;     /* required so the knob centers correctly */
        margin: 0 auto;
        border: 2px dashed var(--accent);
        border-radius: 14px;
        background: rgba(14,165,164,0.06);
        touch-action: none;     /* prevent page scroll while dragging */
    }


    .list-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }

    .btn-waypoint {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--ink);
      padding: 10px 8px;
      font-weight: 600;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .btn-waypoint:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(2,8,23,0.06); }
    .btn-waypoint:disabled { opacity: .55; transform: none; box-shadow: none; }

    .loading { color: var(--muted); text-align: center; padding: 18px; }

    .cam-box { height: 240px; background: #000; border-radius: 12px; display: grid; place-items: center; overflow: hidden; }

    .help { color: var(--muted); font-size: .9rem; }
    /* ADDED: center the 3D viewer contents */
    #div3DViewer { 
    display: grid; 
    place-items: center; 
    }

    /* ADDED: center any canvas/img injected by ROS3D */
    #div3DViewer canvas,
    #div3DViewer img {
    margin: 0 auto;
    max-width: 100%;
    height: auto;
    display: block;
    }

  </style>
</head>
<body>
  <div id="app" class="app-shell">

    <!-- Top bar / connection controls -->
    <div class="topbar py-3">
      <div class="container-fluid d-flex flex-wrap align-items-center">
        <div class="mr-auto d-flex align-items-center mb-2 mb-md-0">
          <span class="brand h4 mb-0">FastBot Console</span>
        </div>

        <div class="input-group input-group-sm" style="max-width: 560px;">
          <div class="input-group-prepend">
            <span class="input-group-text">ROSBridge</span>
          </div>
          <input
            type="text"
            class="form-control"
            v-model="rosbridge_address"
            placeholder="ws://<host>:9090"
            :disabled="connected"
          />
          <div class="input-group-append" v-if="!connected">
            <button class="btn btn-accent" @click="connect" :disabled="loading || connected">Connect</button>
          </div>
          <div class="input-group-append" v-else>
            <button class="btn btn-outline-secondary" @click="disconnect">Disconnect</button>
          </div>
        </div>

        <div class="ml-3 pill">
          <span class="dot" :class="connected ? 'on' : ''"></span>
          <strong>{{ connected ? 'Connected' : 'Disconnected' }}</strong>
        </div>
      </div>
    </div>

    <!-- Main content area -->
    <div class="container-fluid content">

      <!-- Sidebar (left) -->
      <div class="panel">
        <div class="panel-body">
          <h6 class="mb-3">Robot Status</h6>
          <div class="status-chip mb-3">
            <div class="chip">
              <div class="v">{{ robotStatus.speed.toFixed(2) }} m/s</div>
              <small>Speed</small>
            </div>
            <div class="chip">
              <div class="v">{{ robotStatus.battery.toFixed(2) }}%</div>
              <small>Battery</small>
            </div>
          </div>
          <div class="status-chip mb-3">
            <div class="chip">
              <div class="v">X {{ robotStatus.position.x.toFixed(2) }}m</div>
              <small>Position</small>
            </div>
            <div class="chip">
              <div class="v">Y {{ robotStatus.position.y.toFixed(2) }}m</div>
              <small>Position</small>
            </div>
          </div>
          <div class="chip mb-4">
            <div class="v">{{ robotStatus.orientation.toFixed(1) }}°</div>
            <small>Orientation</small>
          </div>

            <h6 class="mb-3">Joystick</h6>
            <div class="joystick-wrap mb-2">
            <div id="joystickContainer"></div>
            </div>
            <div class="text-center help">Mode: <strong>{{ controlMode }}</strong></div>
        </div>
      </div>

      <!-- Center column -->
      <div class="d-grid" style="display:grid; grid-template-rows: 1fr auto; gap: 16px;">
        <div class="panel">
          <div class="panel-body">
            <h6 class="mb-2">Environment Map</h6>
            <div class="viewer" id="mapViewer">
              <div class="loading" v-if="!mapLoaded">Loading map…</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-body">
            <h6 class="mb-2">Robot 3D Model</h6>
            <div class="viewer tall" id="div3DViewer">
              <div class="loading" v-if="!robot3DLoaded">Loading 3D model…</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right column -->
      <div class="panel">
        <div class="panel-body">
          <h6 class="mb-2">Camera</h6>
          <div class="cam-box mb-3" id="cameraViewer">
            <div class="loading" v-if="!cameraLoaded">{{ cameraStatus }}</div>
          </div>

          <h6 class="mb-2">Waypoints</h6>
          <div class="list-grid mb-3">
            <button
              v-for="(waypoint, key) in waypoints"
              :key="key"
              class="btn btn-waypoint"
              @click="goToWaypoint(key)"
              :disabled="!connected || isNavigating"
            >
              {{ waypoint.name }}
            </button>
          </div>

          <button
            class="btn btn-emph btn-lg btn-block"
            @click="emergencyStop"
            :disabled="!connected"
          >
            EMERGENCY STOP
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Cache-busted main.js loader (kept for functional parity) -->
  <script type="text/javascript">
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = 'main.js?v=17.' + Date.now();
    document.head.appendChild(script);
  </script>
</body>
</html>
