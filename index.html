<!DOCTYPE html>
<html>
<head>
  <title>Moon's Robot Cafe !</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

  <!-- ROS libs -->
  <script src="https://cdn.jsdelivr.net/npm/easeljs/lib/easeljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eventemitter2/lib/eventemitter2.min.js"></script>
  <!-- <script src="https://s3.eu-west-1.amazonaws.com/rosject.io/js/roslib.min.js"></script> -->
  <script src="./libs/roslib.min.js"></script>
  <script src="ros2d.js"></script>
  <script src="mjpegcanvas.min.js"></script>

  <!-- 3D visualization -->
  <script src="./libs/three.min.js"></script>
  <script src="./libs/ColladaLoader.js"></script>
  <script src="./libs/ColladaLoader2.js"></script>
  <script src="./libs/STLLoader.js"></script>
  <script src="./libs/ros3d.min.js"></script>

  <!-- Vue -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>

  <style>
    /* Slim header */
    header.app-header { padding: .6rem 0; }
    header .ros-label { font-size: .9rem; margin: 0 .5rem 0 0; }

    /* Same card heights in each row */
    .row.equal > [class*="col-"] .card { height: 100%; }

    /* Camera / Map boxes */
    #map, #divCamera { width: 100%; height: 320px; border: 1px solid #ddd; }

    /* Joystick pad + handle */
    #dragstartzone {
      position: relative; display: inline-block;
      width: 240px; height: 240px;
      border: 1px solid #333; border-radius: 50%; user-select: none;
    }
    #dragCircle {
      position: absolute; width: 48px; height: 48px;
      border-radius: 50%; background: rgba(0,0,0,.3);
      transform: translate(-50%, -50%); /* keep handle truly centered on coords */
      pointer-events: none;
    }
    #dragCircle:hover { background: rgba(255,0,0,.35); }
  </style>
</head>

<body class="d-flex flex-column min-vh-100">

  <!-- Header -->
  <header class="app-header border-bottom">
    <div class="container">
      <div class="row align-items-center">
        <!-- Title (L) -->
        <div class="col-12 col-lg-4 mb-2 mb-lg-0">
          <h2 class="h3 mb-0">Moon's FastBot DashBoard!</h2>
        </div>

        <!-- ROSBridge address + input (C) -->
        <div class="col-12 col-lg-5 mb-2 mb-lg-0 d-flex align-items-center">
          <span class="ros-label">ROSBridge address</span>
          <input
            type="text"
            v-model="rosbridge_address"
            class="form-control form-control-sm"
            placeholder="wss://..."
          />
        </div>

        <!-- Connect / Connected (R) -->
        <div class="col-12 col-lg-3 d-flex justify-content-lg-end">
          <button class="btn btn-success" v-if="connected" @click="disconnect">Connected!</button>
          <button class="btn btn-primary" v-else @click="connect">Connect!</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main id="app" class="flex-grow-1">
    <div class="container py-3">

      <!-- ROW 1: Camera | Joystick | Robot Status -->
      <div class="row equal">
        <!-- Camera (TL) -->
        <div class="col-12 col-md-6 col-lg-4 mb-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title mb-2">Camera</h5>
              <div id="divCamera" class="d-flex justify-content-center align-items-center"></div>
            </div>
          </div>
        </div>

        <!-- Joystick (TM) -->
        <div class="col-12 col-md-6 col-lg-4 mb-3">
          <div class="card">
            <div class="card-body d-flex flex-column align-items-center">
              <h5 class="card-title">JoyStick</h5>
              <div class="small text-muted mb-2">
                Vertical: {{ joystick.vertical.toFixed(3) }} &nbsp;|&nbsp;
                Horizontal: {{ joystick.horizontal.toFixed(3) }}
              </div>

              <!-- Centered joystick -->
              <div class="flex-grow-1 d-flex justify-content-center align-items-center w-100">
                <div id="dragstartzone"
                     @mousedown="startDrag"
                     @mousemove="doDrag"></div>
                <div id="dragCircle" :style="dragCircleStyle"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Robot Status (TR) -->
        <div class="col-12 col-lg-4 mb-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-center">Robot Status</h5>
              <div class="row text-center">
                <div class="col-6 mb-2">
                  <div class="border rounded p-2">
                    <div class="h5 mb-0">{{ robotStatus.speed.toFixed(2) }} m/s</div>
                    <small class="text-muted">Linear Speed</small>
                  </div>
                </div>
                <div class="col-6 mb-2">
                  <div class="border rounded p-2">
                    <div class="h5 mb-0">{{ robotStatus.speedAngular.toFixed(2) }} rad/s</div>
                    <small class="text-muted">Angular Speed</small>
                  </div>
                </div>
                <div class="col-6 mb-2">
                  <div class="border rounded p-2">
                    <div class="h5 mb-0">X {{ robotStatus.position.x.toFixed(2) }} m</div>
                    <small class="text-muted">Position</small>
                  </div>
                </div>
                <div class="col-6 mb-2">
                  <div class="border rounded p-2">
                    <div class="h5 mb-0">Y {{ robotStatus.position.y.toFixed(2) }} m</div>
                    <small class="text-muted">Position</small>
                  </div>
                </div>
                <div class="col-6 mb-2">
                  <div class="border rounded p-2">
                    <div class="h5 mb-0">{{ robotStatus.orientation.toFixed(1) }} deg</div>
                    <small class="text-muted">Orientation</small>
                  </div>
                </div>
                <div class="col-6 mb-2">
                  <div class="border rounded p-2">
                    <div class="h5 mb-0">{{ robotStatus.battery.toFixed(2) }}%</div>
                    <small class="text-muted">Battery</small>
                  </div>
                </div>
              </div> <!-- row -->
            </div>
          </div>
        </div>
      </div>

      <!-- ROW 2: Map | Robot Model | WayPoint -->
      <div class="row equal">
        <!-- Map (BL) -->
        <div class="col-12 col-md-6 col-lg-4 mb-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title mb-2">Map</h5>
              <div id="map" class="d-flex justify-content-center align-items-center"></div>
            </div>
          </div>
        </div>

        <!-- Robot Model (BM) -->
        <div class="col-12 col-md-6 col-lg-4 mb-3">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Robot Model</h5>
              <div id="div3DViewer" class="d-flex justify-content-center"></div>
            </div>
          </div>
        </div>

        <!-- WayPoint + E-Stop (BR) -->
        <div class="col-12 col-lg-4 mb-3">
          <div class="card">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title text-center">WayPoint</h5>
              <div class="row">
                <div class="col-6 col-md-4 mb-2" v-for="(wp, key) in waypoints" :key="key">
                  <button class="btn btn-outline-primary w-100"
                          :disabled="!connected || isNavigating || estopActive"
                          @click="goToWaypoint(key)">
                    {{ wp.name }}
                  </button>
                </div>
              </div>

              <div class="mt-auto pt-2 text-center">
                <button class="btn btn-danger" :disabled="!connected" @click="emergencyStop">
                  EMERGENCY STOP
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- /container -->
  </main>

  <!-- Footer -->
  <footer class="footer mt-auto bg-dark text-light py-3">
    <div class="container">
      <span>page ends here!</span>
    </div>
  </footer>

  <!-- Load main.js with cache-buster -->
  <script>
    var script = document.createElement('script');
    script.src = 'main.js?v=7.' + Date.now();
    document.head.appendChild(script);
  </script>
</body>
</html>
